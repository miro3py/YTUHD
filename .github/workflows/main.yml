name: Build YTUHD dylib (FULL AUTO STABLE)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      # --------------------------------
      # Checkout source
      # --------------------------------
      - name: Checkout repo
        uses: actions/checkout@v4

      # --------------------------------
      # Install Theos
      # --------------------------------
      - name: Install Theos
        run: |
          git clone --recursive https://github.com/theos/theos.git $HOME/theos
          echo "THEOS=$HOME/theos" >> $GITHUB_ENV

      # --------------------------------
      # Install build deps
      # --------------------------------
      - name: Install dependencies
        run: |
          brew install ldid make dpkg

      # --------------------------------
      # Fetch ALL missing headers
      # --------------------------------
      - name: Clone YouTubeHeader
        run: |
          git clone https://github.com/PoomSmart/YouTubeHeader.git

      - name: Clone PSHeader
        run: |
          git clone https://github.com/PoomSmart/PSHeader.git

      # --------------------------------
      # Fix include search path
      # (GitHub runner nema THEOS include auto)
      # --------------------------------
      - name: Export header include paths
        run: |
          echo "ADDITIONAL_CFLAGS=-I$GITHUB_WORKSPACE/YouTubeHeader -I$GITHUB_WORKSPACE/PSHeader" >> $GITHUB_ENV

      # --------------------------------
      # Build tweak dylib
      # SIDELOAD=1 disables undirect lib
      # FINALPACKAGE=0 skips deb packaging
      # --------------------------------
      - name: Build YTUHD dylib
        run: |
          export THEOS=$HOME/theos
          make clean
          make SIDELOAD=1 FINALPACKAGE=0

      # --------------------------------
      # Locate dylib safely
      # --------------------------------
      - name: Locate dylib
        id: dylib
        run: |
          FILE=$(find .theos -type f -name "YTUHD.dylib" | head -n 1)
          echo "file=$FILE" >> $GITHUB_OUTPUT
          echo "Found $FILE"

      # --------------------------------
      # Create draft release
      # --------------------------------
      - name: Create Draft Release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          tag_name: build-${{ github.run_number }}
          name: YTUHD CI Build ${{ github.run_number }}
          files: ${{ steps.dylib.outputs.file }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
